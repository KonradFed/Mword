<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HRMS – Dashboard</title>
  <link rel="stylesheet" th:href="@{/style.css}" />
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-icon">HR</div>
      <div class="brand-text">
        <h1>HRMS – PostgreSQL vs Neo4j</h1>
        <p>CRUD · pagination · time measurement</p>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="two-col">

      <!-- ============ PostgreSQL ============ -->
      <section class="card" id="pgCard">
        <div class="card-head">
          <h2>PostgreSQL</h2>
          <div class="head-right">
            <span class="badge" th:text="'Rows: ' + ${pgCount}">Rows: 0</span>
            <span class="badge">
              <span th:if="${pgTimeMs != null and !pgTimeMs.toString().equals('NaN')}"
                    th:text="${#numbers.formatDecimal(pgTimeMs,1,2)} + ' ms'">0.00 ms</span>
              <span th:unless="${pgTimeMs != null and !pgTimeMs.toString().equals('NaN')}">—</span>
            </span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="data data--wide" id="pgTable">
            <thead>
              <tr>
                <th>ID</th><th>First name</th><th>Last name</th><th>Email</th><th>Phone</th>
                <th>Hire date</th><th>Job</th><th>Min</th><th>Max</th><th>Dept</th><th>Location</th>
              </tr>
            </thead>
            <tbody>
            <tr th:each="e : ${pgRows}"
                th:attr="data-id=${e.employeeId},data-first=${e.firstName},data-last=${e.lastName}">
              <td th:text="${e.employeeId}">1</td>
              <td th:text="${e.firstName}">Jan</td>
              <td th:text="${e.lastName}">Kowalski</td>
              <td th:text="${e.email}">jan@example.com</td>
              <td th:text="${e.phone}">600100200</td>
              <td th:text="${e.hireDate}">2020-01-15</td>
              <td th:text="${e.jobTitle}">Software Engineer</td>
              <td th:text="${e.jobMinSalary}">4000</td>
              <td th:text="${e.jobMaxSalary}">9000</td>
              <td th:text="${e.departmentName}">IT</td>
              <td th:text="${e.location}">Warsaw</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="pager">
          <div class="chip">
            <span>Page</span>
            <strong th:text="${pgPage + 1}">1</strong>
            <span>/</span>
            <strong th:text="${pgPages}">1</strong>
          </div>
          <div class="pager__btns">
            <a class="btn ghost"
               th:classappend="${pgPage<=0} ? ' disabled'"
               th:href="@{|/dashboard?page=${pgPage-1}&size=${size}|}">← Previous</a>
            <a class="btn ghost"
               th:classappend="${pgPage>=pgPages-1} ? ' disabled'"
               th:href="@{|/dashboard?page=${pgPage+1}&size=${size}|}">Next →</a>
          </div>
        </div>
      </section>

      <!-- ============ Actions (CRUD) ============ -->
      <aside class="actions">
        <div class="stack">
          <button class="btn ok"    type="button" id="btnAdd">Add (PG+Neo)</button>
          <a class="btn ghost" th:href="@{|/dashboard?page=${pgPage}&size=${size}&refresh=1|}">Read / Refresh</a>
          <button class="btn"       type="button" id="btnEdit">Edit (PG+Neo)</button>
          <button class="btn danger" type="button" id="btnDelete">Delete (PG+Neo)</button>
        </div>
      </aside>

      <!-- ============ Neo4j ============ -->
      <section class="card" id="neoCard">
        <div class="card-head">
          <h2>Neo4j</h2>
          <div class="head-right">
            <span class="badge" th:text="'Rows: ' + ${neoCount}">Rows: 0</span>
            <span class="badge">
              <span th:if="${neoTimeMs != null and !neoTimeMs.toString().equals('NaN')}"
                    th:text="${#numbers.formatDecimal(neoTimeMs,1,2)} + ' ms'">0.00 ms</span>
              <span th:unless="${neoTimeMs != null and !neoTimeMs.toString().equals('NaN')}">—</span>
            </span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="data data--wide" id="neoTable">
            <thead>
            <tr>
              <th>ID</th><th>First</th><th>Last</th><th>Email</th><th>Phone</th>
              <th>Hire date</th><th>Job</th><th>Min</th><th>Max</th><th>Dept</th><th>Location</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="m : ${neoRows}"
                th:with="id=${m['employeeId']}, fn=${m['firstName']}, ln=${m['lastName']}"
                th:attr="data-id=${id},data-first=${fn},data-last=${ln}">
              <td th:text="${m['employeeId']}">1</td>
              <td th:text="${m['firstName']}">Jan</td>
              <td th:text="${m['lastName']}">Kowalski</td>
              <td th:text="${m['email']}">jan@example.com</td>
              <td th:text="${m['phone']}">600100200</td>
              <td th:text="${m['hireDate']}">2020-01-15</td>
              <td th:text="${m['title']}">Software Engineer</td>
              <td th:text="${m['minSalary']}">4000</td>
              <td th:text="${m['maxSalary']}">9000</td>
              <td th:text="${m['departmentName']}">IT</td>
              <td th:text="${m['location']}">Warsaw</td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="pager">
          <div class="chip">
            <span>Page</span>
            <strong th:text="${neoPage + 1}">1</strong>
            <span>/</span>
            <strong th:text="${neoPages}">1</strong>
          </div>
          <div class="pager__btns">
            <a class="btn ghost"
               th:classappend="${neoPage<=0} ? ' disabled'"
               th:href="@{|/dashboard?page=${neoPage-1}&size=${size}|}">← Previous</a>
            <a class="btn ghost"
               th:classappend="${neoPage>=neoPages-1} ? ' disabled'"
               th:href="@{|/dashboard?page=${neoPage+1}&size=${size}|}">Next →</a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- ====================== MODALS ====================== -->

  <!-- ADD -->
  <dialog id="addModal" class="modal">
    <form method="post" class="modal__card" th:action="@{/add-both}">
      <div class="modal__head">
        <h3>Add employee (PG + Neo)</h3>
        <button type="button" class="modal__close" onclick="closeAdd()">×</button>
      </div>
      <div class="modal__body grid">
        <label>First name
          <input name="firstName" required>
        </label>
        <label>Last name
          <input name="lastName" required>
        </label>
        <label>Email
          <input name="email" type="email" required>
        </label>
        <label>Phone
          <input name="phone">
        </label>
        <label>Hire date
          <input name="hireDate" type="date" required>
        </label>

        <label>Department (PG)
          <select name="departmentId" id="addDept" required>
            <option value="">— select —</option>
            <option th:each="d : ${departments}"
                    th:value="${d.departmentId}"
                    th:text="${d.departmentName + ' — ' + d.location}">
            </option>
          </select>
        </label>

        <label>Job (PG / Neo)
          <select name="jobId" id="addJob" required>
            <option value="">— select —</option>
            <option th:each="j : ${jobs}"
                    th:value="${j.jobId}"
                    th:text="${j.title}">
            </option>
          </select>
        </label>
      </div>
      <div class="modal__foot">
        <button class="btn ghost" type="button" onclick="closeAdd()">Cancel</button>
        <button class="btn ok" type="submit">Save</button>
      </div>
    </form>
  </dialog>

  <!-- EDIT -->
  <dialog id="editModal" class="modal">
    <form method="post" class="modal__card" th:action="@{/edit-both}">
      <div class="modal__head">
        <h3>Edit employee (PG + Neo)</h3>
        <button type="button" class="modal__close" onclick="closeEdit()">×</button>
      </div>
      <div class="modal__body grid">
        <input type="hidden" name="employeeId" id="editId">

        <label>First name
          <input name="firstName" id="editFirst">
        </label>
        <label>Last name
          <input name="lastName" id="editLast">
        </label>
        <label>Email
          <input name="email" id="editEmail" type="email">
        </label>
        <label>Phone
          <input name="phone" id="editPhone">
        </label>
        <label>Hire date
          <input name="hireDate" id="editHire" type="date">
        </label>

        <label>Department (PG)
          <select name="departmentId" id="editDept">
            <option value="">— select —</option>
            <option th:each="d : ${departments}"
                    th:value="${d.departmentId}"
                    th:text="${d.departmentName + ' — ' + d.location}">
            </option>
          </select>
        </label>

        <label>Job (PG / Neo)
          <select name="jobId" id="editJob">
            <option value="">— select —</option>
            <option th:each="j : ${jobs}"
                    th:value="${j.jobId}"
                    th:text="${j.title}">
            </option>
          </select>
        </label>
      </div>
      <div class="modal__foot">
        <button class="btn ghost" type="button" onclick="closeEdit()">Cancel</button>
        <button class="btn ok" type="submit">Save</button>
      </div>
    </form>
  </dialog>

  <!-- DELETE (bez wpisywania ID – działa na wybranym rekordzie) -->
  <dialog id="deleteModal" class="modal">
    <form method="post" class="modal__card" th:action="@{/delete-both}">
      <div class="modal__head">
        <h3>Delete employee</h3>
        <button type="button" class="modal__close" onclick="closeDelete()">×</button>
      </div>
      <div class="modal__body">
        <input type="hidden" name="employeeId" id="deleteId">
        <p>Are you sure you want to delete <strong id="deleteWho">this employee</strong> in PG and Neo?</p>
      </div>
      <div class="modal__foot">
        <button class="btn ghost" type="button" onclick="closeDelete()">Cancel</button>
        <button class="btn danger" type="submit">Delete</button>
      </div>
    </form>
  </dialog>

  <script>
    // ===== helpers =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const pgTable  = $('#pgTable');
    const neoTable = $('#neoTable');

    const addModal = $('#addModal');
    const editModal = $('#editModal');
    const delModal  = $('#deleteModal');

    const btnAdd    = $('#btnAdd');
    const btnEdit   = $('#btnEdit');
    const btnDelete = $('#btnDelete');

    function openAdd(){ addModal.showModal(); }
    function closeAdd(){ addModal.close(); }
    function openEdit(){ editModal.showModal(); }
    function closeEdit(){ editModal.close(); }
    function openDelete(){ delModal.showModal(); }
    function closeDelete(){ delModal.close(); }

    // ===== selection sync across tables =====
    let selectedId = null;

    function clearSelection() {
      $$('#pgTable tbody tr.sel, #neoTable tbody tr.sel').forEach(tr => tr.classList.remove('sel'));
    }

    function selectById(id) {
      selectedId = id;
      clearSelection();
      // mark in both
      const pg = $(`#pgTable tbody tr[data-id="${id}"]`);
      const neo = $(`#neoTable tbody tr[data-id="${id}"]`);
      if (pg) { pg.classList.add('sel'); pg.scrollIntoView({block:'nearest'}); }
      if (neo) { neo.classList.add('sel'); neo.scrollIntoView({block:'nearest'}); }
    }

    function handleRowClick(ev){
      const tr = ev.target.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');
      selectById(id);

      // preload edit form (prefer PG, else Neo)
      preloadEditFromTables(id);
    }

    async function preloadEditFromTables(id){
      try {
        const res = await fetch(`/api/employee/${id}`);
        const data = await res.json();

        $('#editId').value = id;
        if (data.pg){
          $('#editFirst').value = data.pg.firstName ?? '';
          $('#editLast').value  = data.pg.lastName ?? '';
          $('#editEmail').value = data.pg.email ?? '';
          $('#editPhone').value = data.pg.phone ?? '';
          $('#editHire').value  = data.pg.hireDate ?? '';
          $('#editDept').value  = data.pg.departmentId ?? '';
          $('#editJob').value   = data.pg.jobId ?? '';
        } else if (data.neo){
          $('#editFirst').value = data.neo.firstName ?? '';
          $('#editLast').value  = data.neo.lastName ?? '';
          $('#editEmail').value = data.neo.email ?? '';
          $('#editPhone').value = data.neo.phone ?? '';
          const hd = (data.neo.hireDate ?? '').toString().substring(0,10);
          $('#editHire').value  = hd;
        }
      } catch(_) {}
    }

    pgTable.addEventListener('click', handleRowClick);
    neoTable.addEventListener('click', handleRowClick);

    // ===== CRUD buttons =====
    btnAdd.addEventListener('click', () => openAdd());

    btnEdit.addEventListener('click', () => {
      if(!selectedId){ alert('Select a row first.'); return; }
      openEdit();
    });

    btnDelete.addEventListener('click', () => {
      if(!selectedId){ alert('Select a row first.'); return; }
      // find name to confirm
      const src = document.querySelector(`tr[data-id="${selectedId}"]`);
      const first = src?.getAttribute('data-first') || '';
      const last  = src?.getAttribute('data-last')  || '';
      $('#deleteId').value = selectedId;
      $('#deleteWho').textContent = `${first} ${last}`.trim() || `ID ${selectedId}`;
      openDelete();
    });

    // ===== dependent jobs by department (both Add & Edit) =====
    async function reloadJobsInto(selectEl, deptId){
      const res = await fetch(`/api/jobs?deptId=${encodeURIComponent(deptId || '')}`);
      const list = await res.json();
      selectEl.innerHTML = '<option value="">— select —</option>' +
        list.map(j => `<option value="${j.jobId}">${j.title}</option>`).join('');
    }
    $('#addDept').addEventListener('change', e => reloadJobsInto($('#addJob'), e.target.value));
    $('#editDept').addEventListener('change', e => reloadJobsInto($('#editJob'), e.target.value));
  </script>
</body>
</html>
